<!DOCTYPE html>
<html lang="ru">
<head>
      <title>riuson.com - STM32 HAL UART DMA приём пакетов переменной длины</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="riuson's blog">
    <meta name="author" content="riuson">
    <!-- Bootstrap core CSS -->
    <link href="https://www.riuson.com/theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom fonts for this template -->
    <link href="https://www.riuson.com/theme/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!-- Custom styles for this template -->
    <link href="https://www.riuson.com/theme/css/clean-blog.min.css" rel="stylesheet">
    <link href="https://www.riuson.com/theme/css/pygments.css" rel="stylesheet">




    <meta name="tags" content="STM32" />

</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://www.riuson.com/">riuson.com</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
              <li class="nav-link">
                <a href="https://www.riuson.com/ru/about">О</a>
              </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://www.riuson.com/theme/img/post-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
  <div class="post-heading">
    <h1>STM32 HAL UART DMA приём пакетов переменной длины</h1>
    <span class="meta">
      <time class="published" datetime="2015-07-27T00:00:00+05:00">
        27 Июль 2015 г., Пн
      </time>
    </span>
    <span class="meta">
      
    </span>
  </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-12 mx-auto">
  <article>
    <p>STM32 HAL UART Приём данных переменной длины с помощью DMA.</p>
<p>Добавляем определение обработчика для IDLE.</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/Drivers/STM32F1xx_HAL_Driver/Inc/stm32f1xx_hal_uart.h b/Drivers/STM32F1xx_HAL_Driver/Inc/stm32f1xx_hal_uart.h</span>
<span class="gd">--- a/Drivers/STM32F1xx_HAL_Driver/Inc/stm32f1xx_hal_uart.h</span>
<span class="gi">+++ b/Drivers/STM32F1xx_HAL_Driver/Inc/stm32f1xx_hal_uart.h</span>
<span class="gu">@@ -693,6 +693,7 @@ void HAL_UART_IRQHandler(UART_HandleTypeDef *huart);</span>
 void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart);
 void HAL_UART_TxHalfCpltCallback(UART_HandleTypeDef *huart);
 void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart);
<span class="gi">+void HAL_UART_RxIdleCallback(UART_HandleTypeDef *huart);</span>
 void HAL_UART_RxHalfCpltCallback(UART_HandleTypeDef *huart);
 void HAL_UART_ErrorCallback(UART_HandleTypeDef *huart);
</code></pre></div>


<p>Добавляем обработку прерывания IDLE в обработчик прерываний UART.</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_uart.c b/Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_uart.c</span>
<span class="gd">--- a/Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_uart.c</span>
<span class="gi">+++ b/Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_uart.c</span>
<span class="gu">@@ -1238,6 +1238,15 @@ void HAL_UART_IRQHandler(UART_HandleTypeDef *huart)</span>
     UART_EndTransmit_IT(huart);
   }  

<span class="gi">+  tmp_flag = __HAL_UART_GET_FLAG(huart, UART_FLAG_IDLE);</span>
<span class="gi">+  tmp_it_source = __HAL_UART_GET_IT_SOURCE(huart, UART_IT_IDLE);</span>
<span class="gi">+  /* UART in mode Transmitter end --------------------------------------------*/</span>
<span class="gi">+  if((tmp_flag != RESET) &amp;&amp; (tmp_it_source != RESET))</span>
<span class="gi">+  {</span>
<span class="gi">+    __HAL_UART_CLEAR_IDLEFLAG(huart);</span>
<span class="gi">+    HAL_UART_RxIdleCallback(huart);</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
   if(huart-&gt;ErrorCode != HAL_UART_ERROR_NONE)
   {
     /* Set the UART state ready to be able to start again the process */
<span class="gu">@@ -1248,6 +1257,19 @@ void HAL_UART_IRQHandler(UART_HandleTypeDef *huart)</span>
 }

 /**
<span class="gi">+  * @brief  Rx Idle callbacks.</span>
<span class="gi">+  * @param  huart: Pointer to a UART_HandleTypeDef structure that contains</span>
<span class="gi">+  *                the configuration information for the specified UART module.</span>
<span class="gi">+  * @retval None</span>
<span class="gi">+  */</span>
<span class="gi">+__weak void HAL_UART_RxIdleCallback(UART_HandleTypeDef *huart)</span>
<span class="gi">+{</span>
<span class="gi">+ /* NOTE: This function should not be modified, when the callback is needed,</span>
<span class="gi">+          the HAL_UART_RxIdleCallback can be implemented in the user file</span>
<span class="gi">+  */</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+/**</span>
   * @brief  Tx Transfer completed callbacks.
   * @param  huart: Pointer to a UART_HandleTypeDef structure that contains
   *                the configuration information for the specified UART module.
</code></pre></div>


<p>Доработка задачи приёма.<br>
Настраивается приём через DMA для пакета размером в весь доступный буфер.<br>
Затем идёт ожидание семафора. Семафор устанавливается в обработчике IDLE.<br>
После, вычисляется количество принятых данных, как разница между ожидаемым количеством (размером буфера) и оставшимся (ещё не принятым) CNDTR.</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/Src/freertos.c b/Src/freertos.c</span>
<span class="gh">index a7db5b3..5ffd4df 100644</span>
<span class="gd">--- a/Src/freertos.c</span>
<span class="gi">+++ b/Src/freertos.c</span>
<span class="gu">@@ -38,13 +38,15 @@</span>

 /* USER CODE BEGIN Includes */     
 #include &quot;stm32f1xx_hal.h&quot;
<span class="gi">+#include &lt;string.h&gt;</span>
 /* USER CODE END Includes */

 /* Variables -----------------------------------------------------------------*/
 osThreadId taskTestHandle;
 osThreadId taskSerialCommHandle;
 osThreadId taskDisplayHandle;
<span class="gd">-osSemaphoreId semSerialCommReceivedHandle;</span>
<span class="gi">+osSemaphoreId semSerialCommRxIdleHandle;</span>
<span class="gi">+osSemaphoreId semSerialCommTxCompletedHandle;</span>

 /* USER CODE BEGIN Variables */
 extern UART_HandleTypeDef huart1;
<span class="gu">@@ -75,9 +77,13 @@ void MX_FREERTOS_Init(void) {</span>
   /* USER CODE END RTOS_MUTEX */

   /* Create the semaphores(s) */
<span class="gd">-  /* definition and creation of semSerialCommReceived */</span>
<span class="gd">-  osSemaphoreDef(semSerialCommReceived);</span>
<span class="gd">-  semSerialCommReceivedHandle = osSemaphoreCreate(osSemaphore(semSerialCommReceived), 1);</span>
<span class="gi">+  /* definition and creation of semSerialCommRxIdle */</span>
<span class="gi">+  osSemaphoreDef(semSerialCommRxIdle);</span>
<span class="gi">+  semSerialCommRxIdleHandle = osSemaphoreCreate(osSemaphore(semSerialCommRxIdle), 1);</span>
<span class="gi">+</span>
<span class="gi">+  /* definition and creation of semSerialCommTxCompleted */</span>
<span class="gi">+  osSemaphoreDef(semSerialCommTxCompleted);</span>
<span class="gi">+  semSerialCommTxCompletedHandle = osSemaphoreCreate(osSemaphore(semSerialCommTxCompleted), 1);</span>

   /* USER CODE BEGIN RTOS_SEMAPHORES */
   /* add semaphores, ... */
<span class="gu">@@ -126,10 +132,29 @@ void TaskTestStart(void const * argument)</span>
 void TaskSerialCommStart(void const * argument)
 {
   /* USER CODE BEGIN TaskSerialCommStart */
<span class="gi">+  int i, retval, rcvdCount;</span>
<span class="gi">+  /* Set semaphores to default state */</span>
<span class="gi">+  osSemaphoreWait(semSerialCommRxIdleHandle, osWaitForever);</span>
<span class="gi">+  osSemaphoreWait(semSerialCommTxCompletedHandle, osWaitForever);</span>
   /* Infinite loop */
   for(;;)
   {
<span class="gd">-    osDelay(1000);</span>
<span class="gi">+    uint8_t buffer[32];</span>
<span class="gi">+    memset(buffer, 0, sizeof(buffer));</span>
<span class="gi">+</span>
<span class="gi">+    __HAL_UART_CLEAR_IDLEFLAG(&amp;huart1);</span>
<span class="gi">+    __HAL_UART_ENABLE_IT(&amp;huart1, UART_IT_IDLE);</span>
<span class="gi">+    if (HAL_UART_Receive_DMA(&amp;huart1, buffer, sizeof(buffer)) != HAL_OK) {</span>
<span class="gi">+      // error</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    retval = osSemaphoreWait(semSerialCommRxIdleHandle, osWaitForever);</span>
<span class="gi">+    rcvdCount = sizeof(buffer) - huart1.hdmarx-&gt;Instance-&gt;CNDTR;</span>
<span class="gi">+    HAL_UART_DMAStop(&amp;huart1);</span>
<span class="gi">+</span>
<span class="gi">+    HAL_UART_Transmit_DMA(&amp;huart1, buffer, rcvdCount);</span>
<span class="gi">+    retval = osSemaphoreWait(semSerialCommTxCompletedHandle, osWaitForever);</span>
<span class="gi">+    HAL_UART_DMAStop(&amp;huart1);</span>
   }
   /* USER CODE END TaskSerialCommStart */
 }
<span class="gu">@@ -147,6 +172,21 @@ void TaslDisplayStart(void const * argument)</span>
 }

 /* USER CODE BEGIN Application */
<span class="gi">+void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart)</span>
<span class="gi">+{</span>
<span class="gi">+  osSemaphoreRelease(semSerialCommTxCompletedHandle);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)</span>
<span class="gi">+{</span>
<span class="gi">+  osSemaphoreRelease(semSerialCommRxIdleHandle);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void HAL_UART_RxIdleCallback(UART_HandleTypeDef *huart)</span>
<span class="gi">+{</span>
<span class="gi">+  __HAL_UART_DISABLE_IT(huart, UART_IT_IDLE);</span>
<span class="gi">+  osSemaphoreRelease(semSerialCommRxIdleHandle);</span>
<span class="gi">+}</span>
 /* USER CODE END Application */
</code></pre></div>
  </article>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-md-12 mx-auto">
  <div class="category">
    <a href="https://www.riuson.com/category/misc.html">/misc</a>
  </div>
  <div class="tags">
        <a href="https://www.riuson.com/tag/stm32.html">#STM32</a>
  </div>

<hr>

        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="https://www.riuson.com/theme/vendor/jquery/jquery.min.js"></script>
  <script src="https://www.riuson.com/theme/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="https://www.riuson.com/theme/js/clean-blog.min.js"></script>

</body>
</html>