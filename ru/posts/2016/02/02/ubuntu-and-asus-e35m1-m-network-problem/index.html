<!DOCTYPE html>
<html lang="ru">
<head>
      <title>riuson.com - Ubuntu и Asus E35M1-M, проблема с сетью</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="riuson's blog">
    <meta name="author" content="riuson">
    <!-- Bootstrap core CSS -->
    <link href="https://blog.riuson.com/theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom fonts for this template -->
    <link href="https://blog.riuson.com/theme/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!-- Custom styles for this template -->
    <link href="https://blog.riuson.com/theme/css/clean-blog.min.css" rel="stylesheet">
    <link href="https://blog.riuson.com/theme/css/pygments.css" rel="stylesheet">




    <meta name="tags" content="Ubuntu" />

</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://blog.riuson.com/">riuson.com</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
              <li class="nav-link">
                <a href="https://blog.riuson.com/ru/about">О</a>
              </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://blog.riuson.com/theme/img/post-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
  <div class="post-heading">
    <h1>Ubuntu и Asus E35M1-M, проблема с сетью</h1>
    <span class="meta">
      <time class="published" datetime="2016-02-02T00:00:00+05:00">
        02 Февраль 2016 г., Вт
      </time>
    </span>
    <span class="meta">
      
    </span>
  </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-12 mx-auto">
  <article>
    <p>Плата <a href="https://www.asus.com/ru/Motherboards/E35M1M/">Asus E35M1-M</a> формата Micro-ATX с распаянным процессором AMD APU E-350 Dual-Core.</p>
<p>Проблема: ухудшение пинга со временем (с 1 мс до 10 <strong>секунд</strong> и далее), падение скорости, потери пакетов, отваливание сети.</p>
<p>Впервые столкнулся после покупки платы году так в 2012. Каким-то образом решил проблему и забыл.
Смутно припоминаю, что установил драйвера для сетевой карты из исходников.
После переустановки системы проблема всплыла снова.</p>
<h1>r8168</h1>
<p>На плате встроенная поддержка сети реализуется с помощью <strong>Realtek® 8111E , 1 x Gigabit LAN Controller(s)</strong>.</p>
<div class="highlight"><pre><span></span><code>$ lspci -v

<span class="m">03</span>:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller <span class="o">(</span>rev <span class="m">06</span><span class="o">)</span>
    Subsystem: ASUSTeK Computer Inc. P8P67 and other motherboards
    Flags: bus master, fast devsel, latency <span class="m">0</span>, IRQ <span class="m">24</span>
    I/O ports at e000 <span class="o">[</span><span class="nv">size</span><span class="o">=</span><span class="m">256</span><span class="o">]</span>
    Memory at d0004000 <span class="o">(</span><span class="m">64</span>-bit, prefetchable<span class="o">)</span> <span class="o">[</span><span class="nv">size</span><span class="o">=</span>4K<span class="o">]</span>
    Memory at d0000000 <span class="o">(</span><span class="m">64</span>-bit, prefetchable<span class="o">)</span> <span class="o">[</span><span class="nv">size</span><span class="o">=</span>16K<span class="o">]</span>
    Capabilities: &lt;access denied&gt;
    Kernel driver in use: r8169
</code></pre></div>


<p>Раньше надо было собирать драйвер для 8111/8168 из исходников.
Сейчас в репозитории есть пакет <a href="http://packages.ubuntu.com/wily/r8168-dkms">r8168-dkms</a>.
После его установки контроллер работает уже с иным драйвером:</p>
<div class="highlight"><pre><span></span><code>$ lspci -v

<span class="m">03</span>:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller <span class="o">(</span>rev <span class="m">06</span><span class="o">)</span>
    Subsystem: ASUSTeK Computer Inc. P8P67 and other motherboards
    Flags: bus master, fast devsel, latency <span class="m">0</span>, IRQ <span class="m">24</span>
    I/O ports at e000 <span class="o">[</span><span class="nv">size</span><span class="o">=</span><span class="m">256</span><span class="o">]</span>
    Memory at d0004000 <span class="o">(</span><span class="m">64</span>-bit, prefetchable<span class="o">)</span> <span class="o">[</span><span class="nv">size</span><span class="o">=</span>4K<span class="o">]</span>
    Memory at d0000000 <span class="o">(</span><span class="m">64</span>-bit, prefetchable<span class="o">)</span> <span class="o">[</span><span class="nv">size</span><span class="o">=</span>16K<span class="o">]</span>
    Capabilities: &lt;access denied&gt;
    Kernel driver in use: r8168
</code></pre></div>


<p>Откатить на прежний драйвер можно удалением этого пакета через --purge.</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/141343">Bug #141343: r8169 driver does not work with Realtek "PCI-E" 8111B integrated network controller</a><br/>
<a href="https://unixblogger.wordpress.com/2011/10/18/the-pain-of-an-realtek-rtl8111rtl8168-ethernet-card/">The pain of an Realtek (RTL8111/RTL8168) ethernet card</a></br>
<a href="https://nelsonslog.wordpress.com/2012/01/22/realtek-ethernet-drivers-r8169-vs-r8168/">Realtek ethernet drivers: r8169 vs r8168</a></p>
<p>Однако, говорят, что именно эта проблема с r8168 была закрыта. И действительно, установка этого драйвера в данном случае не помогла. Если в прошлый раз отваливалась локальная сеть, за этой сетевой картой, то теперь сеть провайдера за дискретной сетевой на базе 8139.</p>
<h1>ASM1083</h1>
<p>Простеньким скриптом было обнаружено время возникновения ошибки. Между двумя этими записями:</p>
<div class="highlight"><pre><span></span><code><span class="o">========</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="n">T02</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">34</span><span class="o">+</span><span class="mi">0500</span> <span class="o">========</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="k">from</span> <span class="k">cache</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span> <span class="p">(</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">):</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">62</span> <span class="k">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">998</span> <span class="n">ms</span>
          <span class="n">RX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">500253</span> <span class="n">errors</span><span class="p">:</span><span class="mi">211</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">2370</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">122</span> <span class="n">frame</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">TX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">411349</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">0</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">carrier</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">RX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">393385246</span> <span class="p">(</span><span class="mi">393</span><span class="p">.</span><span class="mi">3</span> <span class="n">MB</span><span class="p">)</span>  <span class="n">TX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">127926222</span> <span class="p">(</span><span class="mi">127</span><span class="p">.</span><span class="mi">9</span> <span class="n">MB</span><span class="p">)</span>

<span class="o">========</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="n">T02</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">34</span><span class="o">+</span><span class="mi">0500</span> <span class="o">========</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="k">from</span> <span class="k">cache</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span> <span class="p">(</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xx</span><span class="p">):</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">62</span> <span class="k">time</span><span class="o">=</span><span class="mi">99</span><span class="p">.</span><span class="mi">7</span> <span class="n">ms</span>
          <span class="n">RX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">500265</span> <span class="n">errors</span><span class="p">:</span><span class="mi">211</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">2370</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">122</span> <span class="n">frame</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">TX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">411361</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">0</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">carrier</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">RX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">393386290</span> <span class="p">(</span><span class="mi">393</span><span class="p">.</span><span class="mi">3</span> <span class="n">MB</span><span class="p">)</span>  <span class="n">TX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">127927258</span> <span class="p">(</span><span class="mi">127</span><span class="p">.</span><span class="mi">9</span> <span class="n">MB</span><span class="p">)</span>
</code></pre></div>


<p>В kern.log обнаружилось соответствие:</p>
<div class="highlight"><pre><span></span><code><span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771329] irq 18: nobody cared (try booting with the &quot;irqpoll&quot; option)</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771426] CPU: 0 PID: 0 Comm: swapper/0 Tainted: G           OE   4.2.0-25-generic #30-Ubuntu</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771430] Hardware name: System manufacturer System Product Name/E35M1-M, BIOS 1401 12/21/2011</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771435]  0000000000000000 e37fa07b054cf793 ffff88013ec03e28 ffffffff817e94c9</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771442]  0000000000000000 ffff880035cdf0bc ffff88013ec03e58 ffffffff810d6b65</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771447]  ffffffff81cbd600 ffff880035cdf000 0000000000000000 0000000000000012</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771452] Call Trace:</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771456]  &lt;IRQ&gt;  [&lt;ffffffff817e94c9&gt;] dump_stack+0x45/0x57</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771474]  [&lt;ffffffff810d6b65&gt;] __report_bad_irq+0x35/0xd0</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771479]  [&lt;ffffffff810d6f0d&gt;] note_interrupt+0x24d/0x290</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771484]  [&lt;ffffffff810d432c&gt;] handle_irq_event_percpu+0x11c/0x180</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771489]  [&lt;ffffffff810d43d9&gt;] handle_irq_event+0x49/0x70</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771494]  [&lt;ffffffff810d742a&gt;] handle_fasteoi_irq+0x9a/0x150</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771499]  [&lt;ffffffff810172b5&gt;] handle_irq+0x25/0x40</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771504]  [&lt;ffffffff817f2eaf&gt;] do_IRQ+0x4f/0xe0</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771508]  [&lt;ffffffff817f0e2b&gt;] common_interrupt+0x6b/0x6b</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771510]  &lt;EOI&gt;  [&lt;ffffffff81060526&gt;] ? native_safe_halt+0x6/0x10</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771522]  [&lt;ffffffff81488261&gt;] arch_safe_halt+0x9/0xd</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771526]  [&lt;ffffffff814889b7&gt;] acpi_safe_halt+0x22/0x2b</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771530]  [&lt;ffffffff814889e0&gt;] acpi_idle_do_entry+0x20/0x30</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771534]  [&lt;ffffffff81488eb0&gt;] acpi_idle_enter+0x1e8/0x21e</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771540]  [&lt;ffffffff81687074&gt;] cpuidle_enter_state+0xf4/0x270</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771544]  [&lt;ffffffff81687227&gt;] cpuidle_enter+0x17/0x20</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771548]  [&lt;ffffffff810bd4f2&gt;] call_cpuidle+0x32/0x60</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771552]  [&lt;ffffffff81687203&gt;] ? cpuidle_select+0x13/0x20</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771556]  [&lt;ffffffff810bd788&gt;] cpu_startup_entry+0x268/0x320</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771562]  [&lt;ffffffff817dda2c&gt;] rest_init+0x7c/0x80</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771568]  [&lt;ffffffff81d50025&gt;] start_kernel+0x48b/0x4ac</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771573]  [&lt;ffffffff81d4f120&gt;] ? early_idt_handler_array+0x120/0x120</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771577]  [&lt;ffffffff81d4f339&gt;] x86_64_start_reservations+0x2a/0x2c</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771581]  [&lt;ffffffff81d4f485&gt;] x86_64_start_kernel+0x14a/0x16d</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771584] handlers:</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771613] [&lt;ffffffff815db9c0&gt;] usb_hcd_irq</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771663] [&lt;ffffffff815db9c0&gt;] usb_hcd_irq</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771712] [&lt;ffffffff815db9c0&gt;] usb_hcd_irq</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771761] [&lt;ffffffff815db9c0&gt;] usb_hcd_irq</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771815] [&lt;ffffffffc01361c0&gt;] rtl8139_interrupt [8139too]</span>
<span class="err">Feb  1 02:06:55 ubuntu kernel: [82015.771878] Disabling IRQ #18</span>
</code></pre></div>


<p>Поиск по <strong>irq "nobody cared"</strong> прояснил, что проблема, вероятно, кроется в чипе ASM1083, используемом на данной материнской плате и на других от Asus:
<a href="https://bugzilla.kernel.org/show_bug.cgi?id=38632">Bug 38632 - IRQ Nobody Cared on Sandybridge Additional Ethernet Card</a></p>
<blockquote>
<p><a href="http://www.asmedia.com.tw/eng/e_show_products.php?item=114">ASMedia ASM1083</a><br/>
 Engaged in High Speed I/O solution development, Asmedia Technology is committed to enlarging product portfolio with introducing PCI Express Bridge Products. <strong>The ASM1083, x1 PCI Express to 32-bit PCI Bridge</strong>, enables users to connect legacy parallel bus devices to the advanced serial PCI Express interface.  The ASM1083 is a PCI Express-to-PCI forward bridge, fully compliant with PCI-SIG PCI Express-to-PCI Bridge Specification1.0.
- Support PCI bus 33 MHz
- Support 3 PCI Masters
- SSC Support
- CLKRUN Support
- PME Support</p>
</blockquote>
<p>Из-за некой ошибки в этом чипе, при работе с устройствами за ним (на шине PCI, которую он обеспечивает), иногда происходит сбой и всё накрывается медным тазом.
Предлагаемые решения:
 - Не подключать ничего к шине PCI, т.е. не работать с устройствами через этот мост;
 - Настроить прерывания устройств на несовпадающие номера (иногда помогает);
 - Добавить <strong>irqpoll</strong> в опции загрузки ядра (иногда помогает);
 - Не покупать платы с чипами от ASMedia.</p>
<p>Драйвера для Windows, якобы, используют именно метод irqpoll. Это хоть и делает работу более стабильной, но отрицательно сказывается на производительности.</p>
  </article>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-md-12 mx-auto">
  <div class="category">
    <a href="https://blog.riuson.com/category/misc.html">/misc</a>
  </div>
  <div class="tags">
        <a href="https://blog.riuson.com/tag/ubuntu.html">#Ubuntu</a>
  </div>

<hr>

        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="https://blog.riuson.com/theme/vendor/jquery/jquery.min.js"></script>
  <script src="https://blog.riuson.com/theme/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="https://blog.riuson.com/theme/js/clean-blog.min.js"></script>

</body>
</html>