---
title:  "Программное подавление дребезга контактов"
date:   2016-09-16 10:00:00 +0500
categories:
  - "STM32"
excerpt: Программное подавление дребезга контактов клавиатуры на микроконтроллере, с использование прерываний. Алгоритм и демонстрация.
---
Обычно я использовал следующий алгоритм антидребезга:

1. Разрешаем EXTI <abbr title="Interrupt Service Routine">ISR</abbr> по входам с клавиш, по обоим фронтам.
1. Происходит ожидание изменения уровня сигнала на входах.
1. Прерывание по EXTI, вызов EXTI ISR.<br>
В EXTI ISR останавливаем и запускаем заново таймер. Например, на 20 мс.
   * Если ко времени вызова ISR таймера произойдёт новый вызов EXTI ISR, то таймер будет перезапущен и начнёт считать заново.
1. Таймер досчитал, вызывается ISR таймера.
Таймер останавливаем.<br>
Здесь состояние клавиатуры можно считать стабильным. Поэтому считываем её состояние и передаём на обработку, куда следует.
1. Переходим к пункту 1.

Этот же метод вполне пригоден для определения таймаута по приёму UART на микроконтроллерах, у которых отсутствует отдельное прерывание по таймауту.

На CyberForum'е заметили, что при плохом контакте прерывания от клавиатуры могут идти слишком часто и микроконтроллер будет всё время висеть в прерываниях.
Отсюда возникла небольшая доработка.

1. Разрешаем EXTI ISR по входам с клавиш, по обоим фронтам.
1. Нажимается ржавая кнопка.
1. По первому вызову EXTI ISR:
  * Запускается таймер;
  * Отключается только вызов ISR по EXTI в NVIC, флаги прерываний продолжают сохраняться в регистре PR;
1. В ISR таймера:
  * Останавливаем таймер;
  * проверяем наличие флага прерывания от EXTI:
     * Если флаг установлен, перезапускаем таймер;
     * Если флаг не установлен, то считываем состояние клавиатуры и передаём на обработку.
1. Переходим к пункту 1.

[<i class="fab fa-youtube"></i> Видео: Демонстрация подавления дребезга контактов](https://youtu.be/fA2tO8wWSKo)

Наличие матричной клавиатуры ничего не меняет. Просто на EXTI надо завести все линии строк либо столбцов, чтобы изменение уровня сигнала из-за любой кнопки вызывало прерывание EXTI.
В момент же считывания состояния матричной клавиатуры прерывания мешать не будут, так как таймер полностью остановлен, а EXTI ISR отключены.
